{% extends "web/poem_base.html" %}

{% block poem_title %} - text{% endblock %}

{% block poem_content %}
<h1>{{ poem|safe }}</h1>
{% if not show_text %}
    <div class="alert alert-warning" role="alert">
        Tato báseň je chráněna autorskými právy, bude zveřejněna až v roce 
        <b>{{ poem.book.public_domain_year|default:"<i>rok zveřejnění není nastaven</i>"}}</b>.
    </div>
{% endif %}
<div class="row">
    <div class="col-9" id="poem-text-only-container">
        {{ poem.html_text|safe }}
    </div>
    <div class="col-3">
        <div class="btn-group" data-toggle="buttons" id="versions-selector">
            <input type="radio" class="btn-check" name="verze" id="puvodni" autocomplete="off">
            <label class="btn btn-outline-primary" for="puvodni">Původní verze</label>
            
            <input type="radio" class="btn-check" name="verze" id="editorska" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="editorska">Editorská verze</label>
        </div>
        <p>
            Kniha <a href="{% url 'book_detail' id=poem.book.id %}">{{ poem.book.title|safe }}</a><br>
            Autor 
            {% if poem.author %}
            kkk
            {% elif poem.book.authorships.all|length == 1 %}
                {% for a in poem.book.authorships.all %}
                    {% if a.person.pseudonym_for %}
                        <a href="{% url 'author_detail' id=a.person.pseudonym_for.id %}">{{ a.person.pseudonym_for }}</a>
                    {% else %}
                        <a href="{% url 'author_detail' id=a.person.id %}">{{ a.person }}</a>
                    {% endif %}
                {% endfor %}
            {% endif%}

        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready( function () {
        var komentars = document.querySelectorAll('komentar');
        komentars.forEach(function(komentar) {
            var dataText = komentar.getAttribute('data-text');
            komentar.setAttribute('title', dataText);
        });
        
        $('komentar').tooltip()

        if(!document.querySelector('#poem-text-only-container').querySelector('verze')) {
            document.querySelector('#versions-selector').style.display = 'none';
        }
        
        // Listen to change event on radio buttons
        document.querySelectorAll('input[name="verze"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                // Display Původní verze content
                if (document.getElementById('puvodni').checked) {
                    document.querySelectorAll('verze[typ="puvodni"]').forEach(function(verze) {
                        verze.style.display = 'inline';
                    });
                    document.querySelectorAll('verze[typ="editorska"]').forEach(function(verze) {
                        verze.style.display = 'none';
                    });
                }
                // Display Editorská verze content
                else {
                    document.querySelectorAll('verze[typ="puvodni"]').forEach(function(verze) {
                        verze.style.display = 'none';
                    });
                    document.querySelectorAll('verze[typ="editorska"]').forEach(function(verze) {
                        verze.style.display = 'inline';
                    });
                }
            });
        });

        // verse numbers
        const container = document.querySelector('#poem-text-only-container');
        // Get all strofa elements within the container
        const strofas = container.querySelectorAll('strofa');

        // Iterate over each strofa
        strofas.forEach(function(strofa, strofaIndex) {
            // Get all verse (<v>) elements within the current strofa
            const verses = strofa.querySelectorAll('v');

            // Iterate over each verse
            verses.forEach(function(verse, verseIndex) {
                // Create a span element for the verse number
                const verseNumberSpan = document.createElement('span');
                verseNumberSpan.classList.add('verse-number');
                // Set the text of the span to match the format {strofaIndex + 1}-{verseIndex + 1}
                verseNumberSpan.textContent = `${strofaIndex + 1}-${verseIndex + 1}`;

                // Insert the verse number span before the verse text
                verse.insertBefore(verseNumberSpan, verse.firstChild);
            });
        });
    });
</script>
{% endblock %}